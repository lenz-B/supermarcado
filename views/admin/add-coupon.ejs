<!-- header -->
<%- include('../layout/adminHeadder.ejs') %>
<section class="content-main">
    <div class="row">
        <div class="col-9">
            <div class="content-header">
                <h2 class="content-title">Add New Coupon</h2>
                <div>
                    <button id="saveButton" class="btn btn-md rounded font-sm hover-up">Save</button>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-body">
                    <div class="mb-4">
                        <label for="coupon_name" class="form-label">Coupon Name</label>
                        <input type="text" placeholder="Enter Coupon Name" class="form-control" id="coupon_name" name="coupon_name" />
                    </div>
                    <div class="row gx-3">
                        <div class="col-md-4 mb-3">
                            <label for="discountPercentage" class="form-label">Discount Percentage</label>
                            <input type="number" placeholder="Enter Discount Percentage" class="form-control" id="discountPercentage" name="discountPercentage" min="1" max="99"/>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="minPurchaseAmount" class="form-label">Min Purchase Amount</label>
                            <input type="number" placeholder="Minimum Purchase Amount" class="form-control" id="minPurchaseAmount" name="minPurchaseAmount" min="1"/>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="maxRedeemableAmount" class="form-label">Max Amount</label>
                            <input type="number" placeholder="Max Redeemable Amount" class="form-control" id="maxRedeemableAmount" name="maxRedeemableAmount" min="1"/>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="expiryDate" class="form-label">Expiry Date</label>
                        <input type="date" placeholder="Type here" class="form-control" id="expiryDate" name="expiryDate"/>
                    </div>
                </div>
            </div>
            <!-- card end// -->
        </div>
    </div>
    <div id="message"></div>   
</section>

<!-- form validation and fetch -->
<script>
    document.getElementById('saveButton').addEventListener('click', function(event) {
        event.preventDefault();
        const couponName = document.getElementById('coupon_name').value;
        const discountPercentage = document.getElementById('discountPercentage').value;
        const minPurchaseAmount = document.getElementById('minPurchaseAmount').value;
        const maxRedeemableAmount = document.getElementById('maxRedeemableAmount').value;
        const expiryDate = document.getElementById('expiryDate').value;
        const couponNameRegex = /^[a-zA-Z0-9\s]+$/;
        const isValidDate = dateString => {
            const currentDate = new Date();
            const inputDate = new Date(dateString);
            return !isNaN(inputDate) && inputDate > currentDate;
        };
        if (!couponName || !discountPercentage || !minPurchaseAmount || !maxRedeemableAmount || !expiryDate ) {
            showMessage('All fields are required', false);
            return;
        }
        if (!couponNameRegex.test(couponName)) {
            showMessage('Coupon name should contain only alphabets, numbers, and spaces', false);
            return;
        }
        if (discountPercentage < 1 || discountPercentage > 99) {
            showMessage('Enter a valid discount percentage', false);
            return;
        }
        if (!isValidDate(expiryDate)) {
            showMessage('Expiry date should be at least one day ahead from the current time', false);
            return;
        }
        const data = {
            coupon_name: couponName,
            discount_percentage: discountPercentage,
            min_purchase_amount: minPurchaseAmount,
            max_redeemable_amount: maxRedeemableAmount,
            expiry_date: expiryDate
        };
        // Send data to backend using fetch
        fetch('add-coupon', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status) {
                showMessage('Coupon added successfully!', true);
                setTimeout(() => {
                    window.location.href = '/admin/coupons';
                }, 3000);
            } else {
                showMessage(data.message, false);
            }
        })
        .catch(error => {
            showMessage('An error occurred: ' + error.message, false);
        });
    });

    function showMessage(message, isSuccess) {
        Swal.fire({
            icon: isSuccess ? 'success' : 'error',
            title: isSuccess ? 'Success' : 'Error',
            text: message,
            confirmButtonColor: '#28a745' // green
        });
    }
</script>
    

<!-- footer -->
<%- include('../layout/adminFooter.ejs') %>