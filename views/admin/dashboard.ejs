<%- include('../layout/adminHeadder.ejs') %>

<style>
    .controls {
      margin-bottom: 20px;
    }
    .controls select {
      margin-right: 10px;
    }
    #topSellingTable {
      width: 100%;
      border-collapse: collapse;
    }
    #topSellingTable th, #topSellingTable td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    #topSellingTable th {
      background-color: #f2f2f2;
    }
    #topSellingTable tr:nth-child(even) {
      background-color: #f9f9f9;
    }
  </style>

       
<section class="content-main">
    <div class="content-header">
        <div>
            <h2 class="content-title card-title">Dashboard</h2>
            <p>Whole data about your business here</p>
        </div>
        <div>
            <a href="/admin/sales-report" class="btn btn-primary"><i class="text-muted material-icons md-post_add"></i>Create report</a>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-3">
            <div class="card card-body mb-4">
                <article class="icontext">
                    <span class="icon icon-sm rounded-circle bg-primary-light">
                        <i class="text-primary material-icons md-monetization_on"></i>
                    </span>
                    <div class="text">
                        <h6 class="mb-1 card-title">Revenue</h6>
                        <span>$<%= overallOrderAmount.toFixed(2) %></span>
                        <span class="text-sm"> Shipping fees are included </span>
                    </div>
                </article>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="card card-body mb-4">
                <article class="icontext">
                    <span class="icon icon-sm rounded-circle bg-success-light">
                        <i class="text-success material-icons md-local_shipping"></i>
                    </span>
                    <div class="text">
                        <h6 class="mb-1 card-title">Orders</h6>
                        <span><%= overallSalesCount %></span>
                        <span class="text-sm"> Excluding orders in transit </span>
                    </div>
                </article>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="card card-body mb-4">
                <article class="icontext">
                    <span class="icon icon-sm rounded-circle bg-warning-light"><i class="text-warning material-icons md-qr_code"></i></span>
                    <div class="text">
                        <h6 class="mb-1 card-title">Products</h6>
                        <span>9.856</span>
                        <span class="text-sm"> In 19 Categories </span>
                    </div>
                </article>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="card card-body mb-4">
                <article class="icontext">
                    <span class="icon icon-sm rounded-circle bg-info-light">
                        <i class="text-info material-icons md-shopping_basket"></i>
                    </span>
                    <div class="text">
                        <h6 class="mb-1 card-title">Monthly Earning</h6>
                        <span>$<%= monthlyEarnings.toFixed(2) %></span>
                        <span class="text-sm"> Based in your local time. </span>
                    </div>
                </article>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-xl-8 col-lg-12">
            <div class="card mb-4">
                <article class="card-body">
                    <h5 class="card-title">Top Selling Products</h5>
                    <select id="timeRangeSelect">
                        <option value="week">Week</option>
                        <option value="month">Month</option>
                        <option value="year">Year</option>
                        <option value="allTime">All Time</option>
                    </select>
                    <canvas id="topProductsChart" width="400" height="200px"></canvas>

                    <div id="topTenProductsWeekData" style="display: none;"><%= topTenProductsWeek %></div>
                    <div id="topTenProductsMonthData" style="display: none;"><%= topTenProductsMonth %></div>
                    <div id="topTenProductsYearData" style="display: none;"><%= topTenProductsYear %></div>
                    <div id="topTenProductsAllTimeData" style="display: none;"><%= topTenProductsAllTime %></div>
                </article>
                <article class="card-body">
                    <h5 class="card-title">Top Selling Products</h5>
                    <select id="categoryTimeRangeSelect">
                        <option value="week">Week</option>
                        <option value="month">Month</option>
                        <option value="year">Year</option>
                        <option value="allTime">All Time</option>
                    </select>

                    <canvas id="topCategoriesChart" width="400" height="200px"></canvas>

                    <div id="topTenCategoriesWeekData" style="display: none;"><%= topTenCategoriesWeek %></div>
                    <div id="topTenCategoriesMonthData" style="display: none;"><%= topTenCategoriesMonth %></div>
                    <div id="topTenCategoriesYearData" style="display: none;"><%= topTenCategoriesYear %></div>
                    <div id="topTenCategoriesAllTimeData" style="display: none;"><%= topTenCategoriesAllTime %></div>
                </article>
            </div>
        </div>
        <div class="col-xl-4 col-lg-12">
            <div class="card mb-4">
                <article class="card-body">
                    <h5 class="card-title">Top Selling</h5>

                    <div class="controls">
                        <select id="dataTypeSelect">
                            <option value="products">Products</option>
                            <option value="categories">Categories</option>
                        </select>
                        <select id="timeRangeSelect">
                            <option value="week">Week</option>
                            <option value="month">Month</option>
                            <option value="year">Year</option>
                            <option value="allTime">All Time</option>
                        </select>
                    </div>                      
                    <table id="topSellingTable">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th id="nameHeader">Name</th>
                                <th>Quantity Sold</th>
                            </tr>
                        </thead>
                        <tbody id="topSellingTableBody">
                        </tbody>
                    </table>
                      
                    <!-- Keep the existing chart canvases and data divs -->
                      
                    <!-- <canvas id="myChart" height="120px"></canvas> -->
                    <!-- <canvas id="myChart2" height="217"></canvas> -->
                </article>
                <script>
                    document.addEventListener("DOMContentLoaded", function() {
                        const topTenProductsWeekData = JSON.parse(document.getElementById('topTenProductsWeekData').textContent);
                        const topTenProductsMonthData = JSON.parse(document.getElementById('topTenProductsMonthData').textContent);
                        const topTenProductsYearData = JSON.parse(document.getElementById('topTenProductsYearData').textContent);
                        const topTenProductsAllTimeData = JSON.parse(document.getElementById('topTenProductsAllTimeData').textContent);

                        const topTenCategoriesWeekData = JSON.parse(document.getElementById('topTenCategoriesWeekData').textContent);
                        const topTenCategoriesMonthData = JSON.parse(document.getElementById('topTenCategoriesMonthData').textContent);
                        const topTenCategoriesYearData = JSON.parse(document.getElementById('topTenCategoriesYearData').textContent);
                        const topTenCategoriesAllTimeData = JSON.parse(document.getElementById('topTenCategoriesAllTimeData').textContent);
                      
                        let topProductsChart, topCategoriesChart;
                    
                        const renderChart = (chartId, labels, data, label, timeRange) => {
                            const ctx = document.getElementById(chartId).getContext('2d');
                            return new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                label: `${label} (${timeRange})`,
                                data: data,
                                backgroundColor: chartId === 'topProductsChart' ? 'rgba(54, 162, 235, 0.5)' : 'rgba(75, 192, 192, 0.5)',
                                borderColor: chartId === 'topProductsChart' ? 'rgba(54, 162, 235, 1)' : 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                                }]
                            },
                            options: {
                                scales: {
                                y: {
                                    beginAtZero: true
                                }
                                }
                            }
                            });
                        };
                    
                        const updateChart = (chartType, timeRange) => {
                            let data;
                            switch (chartType) {
                            case 'products':
                                if (topProductsChart) topProductsChart.destroy();
                                switch (timeRange) {
                                case 'week': data = topTenProductsWeekData; break;
                                case 'month': data = topTenProductsMonthData; break;
                                case 'year': data = topTenProductsYearData; break;
                                default: data = topTenProductsAllTimeData;
                                }
                                topProductsChart = renderChart('topProductsChart', data.productNames, data.productQuantitiesSold, 'Products Sold', timeRange);
                                break;
                            case 'categories':
                                if (topCategoriesChart) topCategoriesChart.destroy();
                                switch (timeRange) {
                                case 'week': data = topTenCategoriesWeekData; break;
                                case 'month': data = topTenCategoriesMonthData; break;
                                case 'year': data = topTenCategoriesYearData; break;
                                default: data = topTenCategoriesAllTimeData;
                                }
                                topCategoriesChart = renderChart('topCategoriesChart', data.categoryNames, data.categoryQuantitiesSold, 'Categories Sold', timeRange);
                                break;
                            }
                        };

                        const dataTypeSelect = document.getElementById('dataTypeSelect');
                        const timeRangeSelect = document.getElementById('timeRangeSelect');
                        const topSellingTableBody = document.getElementById('topSellingTableBody');
                        const nameHeader = document.getElementById('nameHeader');

                        function getDataForTimeRange(dataType, timeRange) {
                            switch (dataType) {
                                case 'products':
                                switch (timeRange) {
                                    case 'week': return topTenProductsWeekData;
                                    case 'month': return topTenProductsMonthData;
                                    case 'year': return topTenProductsYearData;
                                    case 'allTime': return topTenProductsAllTimeData;
                                }
                                break;
                                case 'categories':
                                switch (timeRange) {
                                    case 'week': return topTenCategoriesWeekData;
                                    case 'month': return topTenCategoriesMonthData;
                                    case 'year': return topTenCategoriesYearData;
                                    case 'allTime': return topTenCategoriesAllTimeData;
                                }
                                break;
                            }
                            return null;
                        }

                        function updateTable() {
                            const dataType = dataTypeSelect.value;
                            const timeRange = timeRangeSelect.value;
                            const data = getDataForTimeRange(dataType, timeRange);

                            console.log('Updating table with:', { dataType, timeRange, data });

                            if (!data) {
                                console.error('No data available for', dataType, timeRange);
                                topSellingTableBody.innerHTML = '<tr><td colspan="3">No data available</td></tr>';
                                return;
                            }

                            nameHeader.textContent = dataType === 'products' ? 'Product Name' : 'Category Name';

                            let tableContent = '';
                            const names = dataType === 'products' ? data.productNames : data.categoryNames;
                            const quantities = dataType === 'products' ? data.productQuantitiesSold : data.categoryQuantitiesSold;

                            if (!names || !quantities || names.length === 0 || quantities.length === 0) {
                                console.error('Invalid data structure:', data);
                                topSellingTableBody.innerHTML = '<tr><td colspan="3">Invalid data structure</td></tr>';
                                return;
                            }

                            names.forEach((name, index) => {
                                tableContent += `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${name}</td>
                                    <td>${quantities[index]}</td>
                                </tr>
                                `;
                            });

                            topSellingTableBody.innerHTML = tableContent;
                        }

                        dataTypeSelect.addEventListener('change', updateTable);
                        timeRangeSelect.addEventListener('change', updateTable);

                        updateTable();
                        
                        updateChart('products', 'month');
                        updateChart('categories', 'month');
                    
                        document.getElementById('productTimeRangeSelect').addEventListener('change', function(e) {
                        updateChart('products', e.target.value);
                        });
                    
                        document.getElementById('categoryTimeRangeSelect').addEventListener('change', function(e) {
                        updateChart('categories', e.target.value);
                        });
                    });
                </script>
            </div>
            <div class="card mb-4">
                <!-- <article class="card-body">
                    <h5 class="card-title">Marketing Chanel</h5>
                    <span class="text-muted font-xs">Facebook</span>
                    <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" style="width: 15%">15%</div>
                    </div>
                    <span class="text-muted font-xs">Instagram</span>
                    <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" style="width: 65%">65%</div>
                    </div>
                    <span class="text-muted font-xs">Google</span>
                    <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" style="width: 51%">51%</div>
                    </div>
                    <span class="text-muted font-xs">Twitter</span>
                    <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" style="width: 80%">80%</div>
                    </div>
                    <span class="text-muted font-xs">Other</span>
                    <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" style="width: 80%">80%</div>
                    </div>
                </article> -->
            </div>
        </div>
    </div>
    <div class="pagination-area mt-30 mb-50">
        <nav aria-label="Page navigation example">
            <ul class="pagination justify-content-start">
                <li class="page-item active"><a class="page-link" href="#">01</a></li>
                <li class="page-item"><a class="page-link" href="#">02</a></li>
                <li class="page-item"><a class="page-link" href="#">03</a></li>
                <li class="page-item"><a class="page-link dot" href="#">...</a></li>
                <li class="page-item"><a class="page-link" href="#">16</a></li>
                <li class="page-item">
                    <a class="page-link" href="#"><i class="material-icons md-chevron_right"></i></a>
                </li>
            </ul>
        </nav>
    </div>
</section>
<!-- content-main end// -->             

<!-- footer -->
<%- include('../layout/adminFooter.ejs') %>
